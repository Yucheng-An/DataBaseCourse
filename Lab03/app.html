<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APP</title>
</head>
<body>
<h1>IndexedDB Object Generator</h1>
<button onclick = startGenerate()>Generate 1000 Sensors</button>
<button onclick = exportIndexedDBData()>Export IndexedDB Data</button>
<script>
  function getCurrentTimestamp() {
    return new Date().toISOString();
  }
  function generateRandomID() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }
  function generateRandomLocation() {
    const latitude = (Math.random() * 180 - 90).toFixed(6);
    const longitude = (Math.random() * 360 - 180).toFixed(6);
    return { latitude, longitude };
  }
  function generateRandomStatus() {
    const statuses = ['working', 'maintenance', 'error'];
    return statuses[Math.floor(Math.random() * statuses.length)];
  }
  function generateObject() {
    return {
      uuid: crypto.randomUUID(),
      sourceDB: "IndexedDB",
      createdTime: getCurrentTimestamp(),
      updatedTime: getCurrentTimestamp(),
      sensorID: generateRandomID(),
      sensorLocation: generateRandomLocation(),
      sensorStatus: generateRandomStatus()
    };
  }
  function startGenerate(){
    let req = indexedDB.open("IndexDB", 1);
    req.onupgradeneeded = function(event) {
      let db = event.target.result;
      db.createObjectStore("Sensor", { keyPath: "id" ,autoIncrement: true});

    };
    req.onsuccess = function(event) {
      let db = event.target.result;
      let transactionSensor = db.transaction("Sensor", "readonly");
      let sensorObjectStore = transactionSensor.objectStore("Sensor");
      let countRequest = sensorObjectStore.count();
      countRequest.onsuccess = function() {
        if (countRequest.result === 0) {
          let transaction = db.transaction("Sensor", "readwrite");
          let sensorObjectStoreWrite = transaction.objectStore("Sensor");
          for (let i = 0; i < 1000; i++) {
            sensorObjectStoreWrite.add(generateObject());
          }
          console.log('1000 sensors data have been added!!!');
          console.log('Starting export IndexedDB data to JSON file...');
            exportIndexedDBData();
        } else {
          console.log(`Database already contains ${countRequest.result} records, stop data generation.`);
        }
      };

      countRequest.onerror = function() {
        console.error('Error counting records in object store');
      };
    };
    req.onerror = function(event) {
      console.error('Error opening IndexedDB:', event.target.errorCode);
    };
  }
  async function exportIndexedDBData() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('ObjectDatabase', 1);
      request.onsuccess = async (event) => {
        const db = event.target.result;
        const transaction = db.transaction('objects', 'readonly');
        const objectStore = transaction.objectStore('objects');
        const allData = objectStore.getAll();
        allData.onsuccess = function () {
          const data = allData.result;
          const jsonData = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonData], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "indexeddb_export.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          resolve();
          alert('IndexedDB data has been exported to a JSON file.');
        };
        allData.onerror = function () {
          reject('Failed to retrieve data from IndexedDB.');
        };
      };
      request.onerror = function (event) {
        reject('Error opening IndexedDB: ' + event.target.errorCode);
      };
    });
  }
</script>
</body>
</html>
